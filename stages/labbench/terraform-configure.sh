

region=$(aws ec2 describe-availability-zones --output text --query 'AvailabilityZones[0].[RegionName]')

userid=$(aws sts get-caller-identity --output text --query 'UserId')

account=$(aws sts get-caller-identity --output text --query 'Account')

config_file_name="terraform/var-backend.secure.auto.tfvars"

cat > $config_file_name <<TEMPLATE
# Generated by terreform-configure.sh 
# DO not edit

# Backend access configuration
# use with -var-file
#
# This part also act as a backend configuration file
# Do not change the key names
# use with -backend-config in init
#

# choose a role associated to the ec2 instance
# make sure the role has the policy AdministratorAccess
profile  = "$userid"

# make sure the bucket exists
# make user or role has access to the bucket and files
bucket = "terraform-$account"

# path to the state file inside the bucket
key = "states/salvia/stages/env-labbench.state"

# do not encrypt the bucket
encrypt = false

# choose a region
region = "$region"
TEMPLATE


